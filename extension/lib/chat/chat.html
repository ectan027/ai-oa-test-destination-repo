<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Interviewer</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: var(--vscode-editor-foreground);
      background-color: var(--vscode-editor-background);
    }
    #chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }
    #chat-form {
      display: flex;
      padding: 10px;
      background: var(--vscode-editor-inactiveSelectionBackground);
    }
    #chat-input {
      flex: 1;
      padding: 8px;
      font-size: 1rem;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
    }
    #chat-submit {
      margin-left: 10px;
      padding: 8px 16px;
      font-size: 1rem;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #chat-submit:hover {
      background-color: var(--vscode-button-hoverBackground);
    }
    .chat-message {
      margin-bottom: 16px;
      border-radius: 8px;
      padding: 10px 16px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background-color: var(--vscode-editor-inactiveSelectionBackground);
      align-self: flex-end;
      margin-left: auto;
    }
    .interviewer {
      background-color: var(--vscode-activityBar-inactiveForeground, rgba(255,255,255,0.1));
      align-self: flex-start;
      margin-right: auto;
    }
    .chat-header {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .chat-content {
      white-space: pre-wrap;
    }
    #interview-controls {
      display: flex;
      justify-content: center;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }
    #start-final-interview {
      padding: 8px 16px;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #start-final-interview:hover {
      background-color: var(--vscode-button-hoverBackground);
    }
    .system-message {
      text-align: center;
      padding: 8px;
      margin: 8px 0;
      font-style: italic;
      color: var(--vscode-editorWarning-foreground);
    }
    #chat-log {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div id="interview-controls">
    <button id="start-final-interview" style="display: none;">Start Final Interview</button>
  </div>
  <div id="chat-log"></div>
  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Type your message..." autocomplete="off" />
    <button id="chat-submit" type="submit">Send</button>
  </form>
  <script>
    (function() {
      const vscode = acquireVsCodeApi(); // VS Code API for message passing
      const chatLog = document.getElementById('chat-log');
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const startFinalInterviewBtn = document.getElementById('start-final-interview');

      // Global variables to store chat history, workspace context, and prompts
      let chatHistory = [];
      let workspaceContext = '';
      let initialPrompt = '';
      let finalPrompt = '';
      let assessmentPrompt = '';
      let initialInterviewStarted = false;
      let finalInterviewStarted = false;

      // Immediately request environment prompts
      vscode.postMessage({ command: 'getEnvironmentPrompts' });

      // Appends a message to the chat log and record it in chatHistory.
      function appendMessage(role, text, isSystemMessage = false) {
        const messageElem = document.createElement('div');
        
        if (isSystemMessage) {
          messageElem.className = 'system-message';
          messageElem.textContent = text;
        } else {
          const sender = role === 'user' ? 'user' : 'interviewer';
          messageElem.className = 'chat-message ' + sender;
          
          const headerElem = document.createElement('div');
          headerElem.className = 'chat-header';
          headerElem.textContent = role === 'user' ? 'You' : 'AI Interviewer';
          
          const contentElem = document.createElement('div');
          contentElem.className = 'chat-content';
          contentElem.textContent = text;
          
          messageElem.appendChild(headerElem);
          messageElem.appendChild(contentElem);
          
          // Record message in history
          chatHistory.push({ role: role === 'user' ? 'user' : 'assistant', content: text });
        }
        
        chatLog.appendChild(messageElem);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      // Send a chat message to the server and handle the response
      async function sendChatMessage(messageText, systemPrompt = '') {
        // Construct the expected messages object
        const systemMessages = [];
        
        // Add the specific interview prompt if provided
        if (systemPrompt) {
          systemMessages.push({ role: "system", content: systemPrompt });
        } else {
          // Default system message
          systemMessages.push({ role: "system", content: 'You are a technical interviewer assessing a software engineering candidate. They have been provided with a coding project. Interview them about their design decisions and implementation.' });
        }
        
        // Always include workspace content
        systemMessages.push({ role: "system", content: "Project workspace content: " + workspaceContext });
        
        const messages = { "messages": [
          ...systemMessages,
          ...chatHistory
        ]};

        vscode.postMessage({ command: 'chatMessage', payload: { messages } });
      }

      // Start the initial interview
      function startInitialInterview() {
        if (initialInterviewStarted) return;
        initialInterviewStarted = true;
        
        // Show a system message indicating the start of the initial interview
        appendMessage('system', '--- Initial Interview Started ---', true);
        
        // Send an empty message to trigger the initial interview
        sendChatMessage('', initialPrompt);
        
        // Show the final interview button after a delay
        setTimeout(() => {
          startFinalInterviewBtn.style.display = 'block';
        }, 5000);
      }

      // Start the final interview
      function startFinalInterview() {
        if (finalInterviewStarted) return;
        finalInterviewStarted = true;
        
        // Show a system message indicating the start of the final interview
        appendMessage('system', '--- Final Interview Started ---', true);
        
        // Send an empty message to trigger the final interview
        sendChatMessage('', finalPrompt);
        
        // Hide the button
        startFinalInterviewBtn.style.display = 'none';
      }

      // Retrieve all files in the workspace
      function requestWorkspaceContext() {
        vscode.postMessage({ command: 'getWorkspaceContent' });
      }
      
      // Retrieve all files immediately then every 30 seconds (reduced frequency to be less intrusive)
      requestWorkspaceContext();
      setInterval(requestWorkspaceContext, 30000);

      // Listen for messages from the extension.
      window.addEventListener('message', event => {
        const message = event.data;
        
        // If we get a GPT response
        if (message.command === 'chatResponse') {
          if (message.error) {
            appendMessage('system', 'Error: ' + message.error, true);
          } else {
            appendMessage('assistant', message.reply || 'No reply');
          }

        // If we get the contents of this workspace
        } else if (message.command === 'workspaceContent') { 
          if (message.error) {
            console.error('Error retrieving workspace content:', message.error);
          } else {
            workspaceContext = message.content;
            
            // Start the initial interview when we first get workspace content
            // and if we have the initial prompt
            if (!initialInterviewStarted && initialPrompt) {
              startInitialInterview();
            }
          }
        
        // If we get the environment prompts
        } else if (message.command === 'environmentPrompts') {
          if (message.error) {
            console.error('Error retrieving environment prompts:', message.error);
          }
          
          initialPrompt = message.initialPrompt;
          finalPrompt = message.finalPrompt;
          assessmentPrompt = message.assessmentPrompt;
          
          // Start the initial interview if we already have workspace content
          if (!initialInterviewStarted && workspaceContext) {
            startInitialInterview();
          }
        }
      });

      // When a new chat message is submitted.
      chatForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;
        
        appendMessage('user', userMessage);
        chatInput.value = '';
        
        // Send the message without a specific system prompt
        sendChatMessage(userMessage);
      });
      
      // Start final interview button handler
      startFinalInterviewBtn.addEventListener('click', () => {
        startFinalInterview();
      });
    }());
  </script>
</body>
</html>